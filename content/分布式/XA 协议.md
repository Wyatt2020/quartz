---
created: 2024-06-27 14:39
modified: 2024-06-29 15:48
tags:
  - 分布式
---

### 什么是 XA 协议

**XA 协议**是一种分布式事务处理的标准协议，主要用于协调和管理跨多个资源管理器（通常是数据库）的事务。该协议由 X/Open 组织（现在的 Open Group）提出，作为开放事务处理（Open Transaction Processing，OTP）模型的一部分，旨在确保分布式事务的 ACID 特性。

### 关键组件

XA 协议定义了三个关键角色：

1. **资源管理器（RM, Resource Manager）**：管理特定的事务资源，如数据库管理系统。它负责事务分支的创建、执行和回滚，典型示例包括 *Oracle*、*MySQL* 等数据库。
    
2. **事务管理器（TM, Transaction Manager）**：作为协调者，负责全局事务的生命周期管理，包括开始、结束（提交或回滚）事务。它确保所有参与的资源管理器要么全部提交事务，要么全部回滚事务，以维护事务的原子性。
    
3. **应用程序（AP, Application Program）**：发起事务并使用事务管理器提供的接口来定义事务边界，但不直接与资源管理器交互进行事务操作。

### 两阶段提交

XA 协议的核心是 [[两阶段提交（2PC）]] 过程，分为：

- **准备阶段（Prepare Phase）**：事务管理器向所有参与的资源管理器发出准备（*Prepare*）请求，询问它们是否准备好提交事务。资源管理器在本地执行事务操作，并锁定所需的资源，然后回复“准备好”或“未准备好”。
    
- **提交阶段（Commit Phase）**：如果所有资源管理器都回复“准备好”，事务管理器会发出提交（*Commit*）命令，要求所有资源管理器提交事务；如果有任何一个资源管理器回复“未准备好”或超时未响应，事务管理器将发出回滚（*Rollback*）命令，所有资源管理器必须撤销它们的事务操作。

> 2PC 是逻辑模型，XA 协议是将这一模型转化为具体实现的规范。

### 接口规范

XA 协议定义了一套接口规范，以 `xa_` 开头的函数供资源管理器实现，以及以 `tx_` 开头的函数供事务管理器使用，来标准化两者之间的通信，确保不同厂商的产品能够协同工作。

### 应用场景

XA 协议常用于需要跨多个数据库或其他事务性资源进行原子操作的场景，如银行转账、订单处理等需要高度一致性的业务。

然而，由于其同步阻塞的性质和潜在的性能开销，现代分布式系统越来越多地采用更灵活的一致性模型和协议。
