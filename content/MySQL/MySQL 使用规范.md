---
created: 2023-11-22 17:17
modified: 2023-11-22 17:19
tags: [MySQL]
---

### 基础规范

- 表存储引擎必须使用 `InnoDB`
- 表字符集默认使用 `utf8`，必要时候使用 `utf8mb4`
	- 通用，无乱码风险，汉字 3 字节，英文 1 字节
	- `utf8mb4` 是 `utf8` 的超集，有存储 4 字节例如表情符号时，使用它
- 禁止使用存储过程，视图，触发器，Event (能让 MySQL 闲着绝对让他闲着)
	- 对数据库性能影响较大，互联网业务，能让站点层和服务层干的事情，不要交到数据库层
	- 调试，排错，迁移都比较困难，扩展性较差
- 禁止在数据库中存储大文件，例如照片，可以将大文件存储在对象存储系统，数据库中存储路径
- 禁止在线上环境做数据库压力测试
- 测试，开发，线上数据库环境必须隔离

### 命名规范

- 库名，表名，列名
	- 必须用小写，采用下划线分隔：`tb_book`
	- abc, Abc, ABC 都是给自己埋坑
	- 必须见名知义，长度不要超过 32 字符
- 库备份必须以 `bak` 为前缀，以日期为后缀
- 从库必须以 `-s` 为后缀
- 备库必须以 `-ss` 为后缀

### 表设计规范

- 单实例表个数必须控制在 2000 个以内
- 单表分表个数必须控制在 1024 个以内
- 表必须有主键，推荐使用 `UNSIGNED` 整数为主键
- 删除无主键的表，如果是 row 模式的主从架构，从库会挂住
- 禁止使用物理外键，如果要保证完整性，应由应用程序实现（如前端下拉选）
	- 外键使得表之间相互耦合，影响 `update` / `delete` 等 SQL 性能，有可能造成死锁，高并发情况下容易成为数据库瓶颈
- 建议将大字段，访问频度低的字段拆分到单独的表中存储，分离冷热数据(具体参考:《如何实施数据库垂直拆分》)

### 列设计规范

- 根据业务区分使用 `tinyint` / `int` / `bigint`，分别会占用 1/4/8 字节
	- 主键推荐用 `bigint`
- 根据业务区分使用 `char`/`varchar`
	- 字段长度固定，或者长度近似的业务场景，适合使用 `char`，能够减少碎片，查询性能高
	- 字段长度相差较大，或者更新较少的业务场景，适合使用 `varchar`，能够减少空间
- 根据业务区分使用 `datetime`/`timestamp`
	- 前者占用 5 个字节，后者占用 4 个字节，存储年使用 `YEAR`，存储日期使用 `DATE`，存储时间使用 `datetime`
- 必须把字段定义为 NOT NULL 并设默认值
	- NULL 的列使用索引，索引统计，值都更加复杂，MySQL 更难优化
	- NULL 需要更多的存储空间
	- NULL 只能采用 IS NULL 或者 IS NOT NULL，而在 `=` / `!=` / `in` / `not in` 时有大坑
- 使用 `INT UNSIGNED` 存储 IPv4，不要用 `char(15)`
- 使用 `varchar(20)` 存储手机号，不要使用整数
	- 牵扯到国家代号，可能出现 `+`/`-`/`()` 等字符，例如+86
	- 手机号不会用来做数学运算
	- `varchar` 可以模糊查询，例如 `like'138%'`
- 使用 `TINYINT` 来代替 `ENUM`
	- `ENUM` 增加新值要进行 DDL 操作

### 索引规范

- 唯一索引使用 `uniq_[字段名]` 来命名
- 非唯一索引使用 `idx_[字段名]` 来命名
- 单张表索引数量建议控制在 5 个以内
	- 互联网高并发业务，太多索引会影响写性能
	- 生成执行计划时，如果索引太多，会降低性能，并可能导致 MySQL 选择不到最优索引
- 异常复杂的查询需求，可以选择 ES 等更为适合的方式存储
- 组合索引字段数建议不超过 5 个
	- 如果 5 个字段还不能极大缩小 row 范围，八成是设计有问题
- 不建议在频繁更新的字段上建立索引
- 非必要不要进行 `JOIN` 查询，如果要进行 `JOIN` 查询，被 `JOIN` 的字段必须类型相同，并建立索引
	- 踩过因为 `JOIN` 字段类型不一致，而导致全表扫描的坑么
- 理解组合索引最左前缀原则，避免重复建设索引，如果建立了 (a, b, c)，相当于建立了 (a)，(a, b)，(a, b, c)
